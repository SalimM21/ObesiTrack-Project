<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Tableau de bord - D√©tection Diab√®te</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <body>
        <header>
            <h1>Mon Tableau de Bord</h1>
            <nav style="display:flex; gap:10px; flex-wrap:wrap;">
                <button id="btnShowStats" class="btn btn-secondary">üìä Statistiques</button>
                <button id="darkModeToggle" class="btn btn-dark">üåô Mode sombre</button>
                <button onclick="location.href='index.html'" class="btn btn-danger">üö™ D√©connexion</button>
            </nav>
        </header>

        <main>
            <h2>Historique de mes pr√©dictions</h2>
            <button onclick="location.href='add_patient.html'" class="btn btn-primary">‚ûï Nouvelle Pr√©diction</button>
            <button onclick="exportCSV()" class="btn btn-secondary">üì• Exporter CSV</button>
            <div style="margin: 15px 0; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <!-- Recherche globale -->
                <input type="text" id="search-input" placeholder="üîç Rechercher (nom, √¢ge, r√©sultat)...">

                <!-- Filtre par intervalle de date -->
                <label for="date-min">Du :</label>
                <input type="date" id="date-min">
                <label for="date-max">Au :</label>
                <input type="date" id="date-max">

                <button onclick="applyFilters()">Filtrer</button>
                <button onclick="resetFilters()">R√©initialiser</button>
            </div>
            <table id="history-table">
                <thead>
                    <tr>
                        <th onclick="sortTable('date')">Date ‚¨ç</th>
                        <th onclick="sortTable('age')">√Çge ‚¨ç</th>
                        <th>FCVC</th>
                        <th>R√©sultat</th>
                        <th>Probabilit√©</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- rempli par app.js -->
                </tbody>
            </table>

            <!-- Section Graphiques -->
            <section id="charts" class="charts-section" style="display:none; margin-top:20px;">
                <h2>üìä Statistiques</h2>
                <canvas id="chartResults" width="400" height="200"></canvas>
                <canvas id="chartProbabilities" width="400" height="200" style="margin-top:30px;"></canvas>
            </section>
        </main>
        <!-- Styles -->
        <style>
            body {
                font-family: Arial, sans-serif;
                background: #fafafa;
                color: #333;
                transition: background 0.3s, color 0.3s;
            }

            header {
                background: #2196F3;
                color: white;
                padding: 15px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            header nav a {
                margin-left: 15px;
                color: white;
                text-decoration: none;
                font-weight: bold;
            }

            header nav button {
                padding: 5px 10px;
                border: none;
                cursor: pointer;
                border-radius: 5px;
            }

            .dashboard {
                display: flex;
                gap: 5%;
                margin-top: 20px;
                padding: 0 15px;
            }

            .table-section {
                flex-basis: 60%;
            }

            .charts-section {
                flex-basis: 35%;
            }


            table td,
            table th {
                text-align: center;
            }

            /* Mode sombre */
            body.dark {
                background: #121212;
                color: #201f1f;
            }

            body.dark header {
                background: #333;
            }

            body.dark header nav a {
                color: #f6f0f0;
            }

            body.dark table thead {
                background: #333;
                color: hsl(0, 0%, 88%);
            }

            body.dark table,
            body.dark th,
            body.dark td {
                border: 1px solid #444;
            }

            body.dark .charts-section h2,
            body.dark .table-section h2 {
                color: #201f1f;
            }

            /* Responsive */
            @media (max-width: 768px) {
                .dashboard {
                    flex-direction: column;
                }

                .table-section,
                .charts-section {
                    flex-basis: 100%;
                }
            }
        </style>
        <style>
            .btn {
                padding: 8px 15px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: bold;
                transition: 0.3s;
            }

            .btn-primary {
                background: #007bff;
                color: white;
            }

            .btn-secondary {
                background: #6c757d;
                color: white;
            }

            .btn-dark {
                background: #343a40;
                color: white;
            }

            .btn-danger {
                background: #dc3545;
                color: white;
            }

            .btn:hover {
                opacity: 0.85;
            }
        </style>

        <!-- Chart.js -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <script>
            // ============================
            // 1Ô∏è‚É£ Donn√©es de pr√©dictions
            // ============================
            const predictions = [
                { date: "2025-01-12", age: 25, fcvc: 2, result: "Sain", probability: 0.85 },
                { date: "2025-02-18", age: 40, fcvc: 1, result: "Surpoids", probability: 0.67 },
                { date: "2025-03-03", age: 32, fcvc: 3, result: "Ob√®se", probability: 0.92 },
                { date: "2025-03-22", age: 28, fcvc: 2, result: "Sain", probability: 0.78 },
                { date: "2025-04-10", age: 35, fcvc: 1, result: "Surpoids", probability: 0.59 },
                { date: "2025-04-25", age: 45, fcvc: 3, result: "Ob√®se", probability: 0.95 },
                { date: "2025-05-15", age: 30, fcvc: 2, result: "Sain", probability: 0.88 },
                { date: "2025-05-30", age: 50, fcvc: 1, result: "Surpoids", probability: 0.70 },
                { date: "2025-06-05", age: 38, fcvc: 3, result: "Ob√®se", probability: 0.91 },
                { date: "2025-06-20", age: 27, fcvc: 2, result: "Sain", probability: 0.82 }
            ];

            // ============================
            // 2Ô∏è‚É£ G√©n√©ration du tableau
            // ============================
            const tableBody = document.querySelector("#history-table tbody");

            function renderHistory(data = predictions) {
                tableBody.innerHTML = "";
                data.forEach(pred => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
            <td>${pred.date}</td>
            <td>${pred.age}</td>
            <td>${pred.fcvc}</td>
            <td class="${pred.result === 'Ob√®se' ? 'result-1' : 'result-0'}">${pred.result}</td>
            <td>${(pred.probability * 100).toFixed(1)}%</td>
        `;
                    tableBody.appendChild(tr);
                });
            }

            // Initialisation du tableau
            renderHistory();

            // ============================
            // 3Ô∏è‚É£ Graphiques
            // ============================

            // 3.1 R√©partition des r√©sultats
            function renderResultsChart() {
                const counts = predictions.reduce((acc, p) => {
                    acc[p.result] = (acc[p.result] || 0) + 1;
                    return acc;
                }, {});

                new Chart(document.getElementById("chartResults"), {
                    type: "pie",
                    data: {
                        labels: Object.keys(counts),
                        datasets: [{
                            data: Object.values(counts),
                            backgroundColor: ["#4CAF50", "#FF9800", "#F44336"]
                        }]
                    },
                    options: {
                        plugins: {
                            title: { display: true, text: "R√©partition des R√©sultats" }
                        }
                    }
                });
            }

            // 3.2 Probabilit√©s dans le temps
            function renderProbabilitiesChart() {
                new Chart(document.getElementById("chartProbabilities"), {
                    type: "line",
                    data: {
                        labels: predictions.map(p => p.date),
                        datasets: [{
                            label: "Probabilit√© pr√©dite",
                            data: predictions.map(p => (p.probability * 100).toFixed(1)),
                            borderColor: "#2196F3",
                            fill: false,
                            tension: 0.2
                        }]
                    },
                    options: {
                        plugins: {
                            title: { display: true, text: "√âvolution des Probabilit√©s (%)" }
                        },
                        scales: { y: { min: 0, max: 100 } }
                    }
                });
            }

            // Rendu initial des graphiques
            renderResultsChart();
            renderProbabilitiesChart();

            // ============================
            // 4Ô∏è‚É£ Bouton statistiques
            // ============================
            const btnShowStats = document.getElementById("btnShowStats");
            const chartsSection = document.getElementById("charts");
            const tableSection = document.getElementById("tableSection");

            btnShowStats.addEventListener("click", () => {
                // V√©rifie si les statistiques sont cach√©es
                const isChartsHidden = chartsSection.style.display === "none" || chartsSection.style.display === "";

                // Toggle affichage
                chartsSection.style.display = isChartsHidden ? "block" : "none";
                tableSection.style.display = isChartsHidden ? "none" : "block";

                // Changer le texte du bouton
                btnShowStats.textContent = isChartsHidden ? "‚¨Ö Retour au tableau" : "üìä Statistiques";

                // Scroll vers la section visible
                const targetSection = isChartsHidden ? chartsSection : tableSection;
                targetSection.scrollIntoView({ behavior: "smooth" });
            });


            // ============================
            // 5Ô∏è‚É£ Mode sombre
            // ============================
            const toggleBtn = document.getElementById("darkModeToggle");
            toggleBtn.addEventListener("click", () => {
                document.body.classList.toggle("dark");
                toggleBtn.textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è Mode clair" : "üåô Mode sombre";
            });

        </script>
        <script>
            function exportCSV() {
                let rows = [["Date", "√Çge", "FCVC", "R√©sultat", "Probabilit√©"]];
                predictions.forEach(p => {
                    rows.push([p.date, p.age, p.fcvc, p.result, (p.probability * 100).toFixed(1) + "%"]);
                });
                let csvContent = "data:text/csv;charset=utf-8,"
                    + rows.map(e => e.join(",")).join("\n");
                const link = document.createElement("a");
                link.setAttribute("href", csvContent);
                link.setAttribute("download", "historique_predictions.csv");
                document.body.appendChild(link);
                link.click();
            }
        </script>
        <script>
            // const tableBody = document.querySelector("#history-table tbody"); // Already declared above
            const searchInput = document.getElementById("search-input");
            const dateMin = document.getElementById("date-min");
            const dateMax = document.getElementById("date-max");

            function renderHistory(filteredData = predictions) {
                tableBody.innerHTML = "";
                for (const pred of filteredData) {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
        <td>${pred.date}</td>
        <td>${pred.age}</td>
        <td>${pred.fcvc}</td>
        <td class="${pred.result === 'Ob√®se' ? 'result-1' : 'result-0'}">${pred.result}</td>
        <td>${(pred.probability * 100).toFixed(1)}%</td>
      `;
                    tableBody.appendChild(tr);
                }
            }

            function applyFilters() {
                const searchTerm = searchInput.value.toLowerCase();
                const minDate = dateMin.value ? new Date(dateMin.value) : null;
                const maxDate = dateMax.value ? new Date(dateMax.value) : null;

                const filtered = predictions.filter(p => {
                    const matchesSearch =
                        p.result.toLowerCase().includes(searchTerm) ||
                        String(p.age).includes(searchTerm) ||
                        String(p.fcvc).includes(searchTerm);

                    const dateObj = new Date(p.date);
                    const matchesDate =
                        (!minDate || dateObj >= minDate) &&
                        (!maxDate || dateObj <= maxDate);

                    return matchesSearch && matchesDate;
                });

                renderHistory(filtered);
            }

            function resetFilters() {
                searchInput.value = "";
                dateMin.value = "";
                dateMax.value = "";
                renderHistory();
            }

            // Activer la recherche en temps r√©el
            searchInput.addEventListener("input", applyFilters);

            // Initialiser le tableau
            renderHistory();
        </script>
        <script>
            let currentSort = { key: null, asc: true };

            function sortTable(key) {
                // Inverser l‚Äôordre si on reclique sur la m√™me colonne
                if (currentSort.key === key) {
                    currentSort.asc = !currentSort.asc;
                } else {
                    currentSort.key = key;
                    currentSort.asc = true;
                }

                const sorted = [...predictions].sort((a, b) => {
                    let valA = a[key];
                    let valB = b[key];

                    // Si la cl√© est "date", convertir en objet Date
                    if (key === "date") {
                        valA = new Date(valA);
                        valB = new Date(valB);
                    }

                    if (valA < valB) return currentSort.asc ? -1 : 1;
                    if (valA > valB) return currentSort.asc ? 1 : -1;
                    return 0;
                });

                renderHistory(sorted);
            }

        </script>




    </body>


    <script src="js/app.js"></script>
</body>

</html>