<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <title>Tableau de bord - D√©tection Diab√®te</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* --- Styles de base --- */
    body {
      font-family: Arial, sans-serif;
      background: #fafafa;
      color: #333;
      transition: background 0.3s, color 0.3s;
    }

    header {
      background: #2196F3;
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header nav button {
      padding: 5px 10px;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    table,
    th,
    td {
      border: 1px solid #ccc;
      text-align: center;
      padding: 8px;
    }

    body.dark {
      background: #121212;
      color: #ddd;
    }

    body.dark header {
      background: #333;
    }

    body.dark table,
    body.dark th,
    body.dark td {
      border: 1px solid #444;
    }

    .btn {
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin: 2px;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-dark {
      background: #343a40;
      color: white;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn:hover {
      opacity: 0.85;
    }

    @media(max-width:768px) {

      table,
      header {
        font-size: 14px;
      }
    }

    .chart-canvas {
      width: 100% !important;
      height: auto !important;
      max-height: 400px;
      /* tu peux ajuster selon tes besoins */
    }

    .charts-section {
      display: flex;
      flex-direction: column;
      gap: 30px;
      max-width: 800px;
      margin: 0 auto;
    }

    @media print {

      header,
      nav,
      #charts,
      .btn {
        display: none;
      }

      table {
        width: 100%;
      }
    }

    .chart-canvas {
      flex: 1;
      min-width: 300px;

      height: 300px;
      /* m√™me hauteur pour les deux */
    }
  </style>
</head>

<body>

  <!-- ===== HEADER ===== -->
  <header
    style="display:flex; justify-content:space-between; align-items:center; padding:15px; background:#2196F3; color:white; flex-wrap:wrap;">

    <!-- Titre -->
    <h1 style="margin:0;">Mon Tableau de Bord</h1>

    <!-- Menu et profil -->
    <div style="display:flex; align-items:center; gap:15px; flex-wrap:wrap;">

      <!-- Boutons principaux -->
      <button id="btnShowStats" class="btn btn-secondary">üìä Statistiques</button>
      <button id="darkModeToggle" class="btn btn-dark">üåô Mode sombre</button>
      <button onclick="location.href='index.html'" class="btn btn-danger">üö™ D√©connexion</button>

      <!-- Profil utilisateur -->
      <div id="user-profile"
        style="display:flex; align-items:center; gap:10px; background:rgba(255,255,255,0.1); padding:5px 10px; border-radius:8px;">
        <img src="images/avatar.png" alt="Profil" style="width:40px; height:40px; border-radius:50%;">
        <div style="line-height:1.2;">
          <div><strong>Salim Majide</strong></div>
          <div style="font-size:0.85em;">R√¥le : Utilisateur</div>
        </div>
        <button class="btn btn-primary" onclick="editProfile()" style="padding:5px 10px; font-size:0.85em;">‚úèÔ∏è
          Modifier</button>
      </div>

    </div>

    <!-- Notifications -->
    <!-- <div id="notifications" style="position:fixed; top:400px; right:20px; z-index:1000;"></div> -->

  </header>




  <!-- ===== MAIN ===== -->
  <main>
    <div id="tableSection">
      <h2>Historique de mes pr√©dictions</h2>
      <button onclick="location.href='add_patient.html'" class="btn btn-primary">‚ûï Nouvelle Pr√©diction</button>
      <button onclick="exportCSV()" class="btn btn-secondary">üì• Exporter CSV</button>
      <button onclick="window.print()" class="btn btn-secondary">üñ® Imprimer</button>
      <div style="margin: 15px 0; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
        <input type="text" id="search-input" placeholder="üîç Rechercher (nom, √¢ge, r√©sultat)...">
        <label for="date-min">Du :</label>
        <input type="date" id="date-min">
        <label for="date-max">Au :</label>
        <input type="date" id="date-max">
        <button onclick="applyFilters()" class="btn btn-secondary">Filtrer</button>
        <button onclick="resetFilters()" class="btn btn-secondary">R√©initialiser</button>
      </div>
      <table id="history-table">
        <thead>
          <tr>
            <th onclick="sortTable('date')">Date ‚¨ç</th>
            <th onclick="sortTable('age')">√Çge ‚¨ç</th>
            <th>FCVC</th>
            <th>R√©sultat</th>
            <th>Probabilit√©</th>
          </tr>
        </thead>
        <tbody><!-- rempli par JS --></tbody>
      </table>
      <div style="margin: 10px 0; display:flex; align-items:center; gap:10px;">
        <label for="rowsPerPage">Afficher :</label>
        <button onclick="prevPage()">‚¨Ö Pr√©c√©dent</button>
        <select id="rowsPerPage" onchange="renderHistoryWithPagination()">
          <option value="5">5</option>
          <option value="10">10</option>
          <option value="20">20</option>
        </select>
        <button onclick="nextPage()">Suivant ‚û°</button>
      </div>

    </div>

    <!-- Filtre p√©riode pour graphiques -->
    <div id="chart-filters" style="margin-top:15px; display:none;">
      <label for="period-select">P√©riode :</label>
      <select id="period-select">
        <option value="all">Toutes les donn√©es</option>
        <option value="3m">3 derniers mois</option>
        <option value="6m">6 derniers mois</option>
      </select>

    </div>


    <!-- Section Graphiques -->
    <section id="charts" class="charts-section" style="display:none; margin-top:20px;">
      <h2>üìä Statistiques</h2>
      <canvas id="chartRadar" class="chart-canvas"></canvas>
      <canvas id="chartProbabilities" class="chart-canvas" style="margin-top:30px;"></canvas>
      <div id="charts-container"
        style="display:flex; gap:30px; margin-top:30px; flex-wrap:wrap; align-items:flex-start; max-width: 500px; margin: 0 auto;">

        <canvas id="chartResults" class="chart-canvas"></canvas>
        <canvas id="chartAgeHistogram" class="chart-canvas"></canvas>

      </div>


    </section>
  </main>


  <!-- ===== SCRIPT ===== -->
  <script>
    // ------------------ DONN√âES ------------------
    let predictions = [];

    const tableBody = document.querySelector("#history-table tbody");

    // Charger les pr√©dictions depuis l'API
    async function loadPredictions() {
      try {
        predictions = await getHistory();
        renderHistory();
        renderCharts(predictions);
      } catch (err) {
        console.error('Erreur lors du chargement des pr√©dictions:', err);
        predictions = [];
        renderHistory();
      }
    }

    function renderHistory(data = predictions) {
      tableBody.innerHTML = "";
      if (!data || data.length === 0) {
        tableBody.innerHTML = "<tr><td colspan='5'>Aucune pr√©diction trouv√©e</td></tr>";
        return;
      }
      
      data.forEach(pred => {
        const tr = document.createElement("tr");
        const payload = JSON.parse(pred.payload || '{}');
        const date = new Date(pred.created_at).toLocaleDateString();
        
        tr.innerHTML = `
          <td>${date}</td>
          <td>${payload.age || '-'}</td>
          <td>${payload.fcvc || '-'}</td>
          <td class="${pred.result.includes('Obese') ? 'result-1' : 'result-0'}">${pred.result}</td>
          <td>${(pred.probability * 100).toFixed(1)}%</td>
        `;
        tableBody.appendChild(tr);
      });
    }

    // ------------------ FILTRE & EXPORT ------------------
    const searchInput = document.getElementById("search-input");
    const dateMin = document.getElementById("date-min");
    const dateMax = document.getElementById("date-max");

    function applyFilters() {
      const searchTerm = searchInput.value.toLowerCase();
      const minDate = dateMin.value ? new Date(dateMin.value) : null;
      const maxDate = dateMax.value ? new Date(dateMax.value) : null;
      const filtered = predictions.filter(p => {
        const payload = JSON.parse(p.payload || '{}');
        const matchesSearch = p.result.toLowerCase().includes(searchTerm) || 
                             String(payload.age || '').includes(searchTerm) || 
                             String(payload.fcvc || '').includes(searchTerm);
        const dateObj = new Date(p.created_at);
        const matchesDate = (!minDate || dateObj >= minDate) && (!maxDate || dateObj <= maxDate);
        return matchesSearch && matchesDate;
      });
      renderHistory(filtered);
    }

    function resetFilters() { searchInput.value = ""; dateMin.value = ""; dateMax.value = ""; renderHistory(); }
    searchInput.addEventListener("input", applyFilters);

    function exportCSV() {
      let rows = [["Date", "√Çge", "FCVC", "R√©sultat", "Probabilit√©"]];
      predictions.forEach(p => {
        const payload = JSON.parse(p.payload || '{}');
        const date = new Date(p.created_at).toLocaleDateString();
        rows.push([date, payload.age || '-', payload.fcvc || '-', p.result, (p.probability * 100).toFixed(1) + "%"]);
      });
      let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
      const link = document.createElement("a"); link.setAttribute("href", csvContent); link.setAttribute("download", "historique_predictions.csv"); document.body.appendChild(link); link.click();
    }

    // ------------------ TRI ------------------
    let currentSort = { key: null, asc: true };
    function sortTable(key) {
      if (currentSort.key === key) currentSort.asc = !currentSort.asc;
      else { currentSort.key = key; currentSort.asc = true; }
      const sorted = [...predictions].sort((a, b) => {
        let valA, valB;
        if (key === "date") {
          valA = new Date(a.created_at);
          valB = new Date(b.created_at);
        } else if (key === "age") {
          const payloadA = JSON.parse(a.payload || '{}');
          const payloadB = JSON.parse(b.payload || '{}');
          valA = payloadA.age || 0;
          valB = payloadB.age || 0;
        } else {
          valA = a[key] || 0;
          valB = b[key] || 0;
        }
        return (valA < valB ? -1 : valA > valB ? 1 : 0) * (currentSort.asc ? 1 : -1);
      });
      renderHistory(sorted);
    }

    // Charger les pr√©dictions au chargement de la page
    loadPredictions();

    // ------------------ GRAPHIQUES ------------------
    function filterByPeriod(period) {
      if (period === "all") return predictions;
      const now = new Date();
      const months = parseInt(period.replace('m', ''));
      const cutoff = new Date(now.setMonth(now.getMonth() - months));
      return predictions.filter(p => new Date(p.created_at) >= cutoff);
    }

    function renderCharts(data) {
      // Pie
      const counts = data.reduce((acc, p) => { acc[p.result] = (acc[p.result] || 0) + 1; return acc; }, {});
      new Chart(document.getElementById("chartResults"), { type: "pie", data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts), backgroundColor: ["#F4CFDF", "#9AC8EB", "#5784BA"] }] }, options: { plugins: { title: { display: true, text: "R√©partition des R√©sultats" } } } });

      // Line Chart - Probabilit√©s
      new Chart(document.getElementById("chartProbabilities"), {
        type: "line",
        data: {
          labels: data.map(p => new Date(p.created_at).toLocaleDateString()),
          datasets: [{
            label: "Probabilit√© pr√©dite (%)",
            data: data.map(p => (p.probability * 100).toFixed(1)),
            borderColor: "#2196F3",
            fill: false,
            tension: 0.2
          }]
        },
        options: {
          plugins: { title: { display: true, text: "√âvolution des Probabilit√©s (%)" } },
          scales: { y: { min: 0, max: 100 } }
        }
      });

      // Histogramme - R√©partition des √¢ges par r√©sultat
      const results = [...new Set(data.map(p => p.result))];
      const ageGroups = results.map(r => data.filter(p => p.result === r).map(p => {
        const payload = JSON.parse(p.payload || '{}');
        return payload.age || 0;
      }));
      new Chart(document.getElementById("chartAgeHistogram"), {
        type: "bar",
        data: {
          labels: results,
          datasets: [{
            label: "√Çge moyen",
            data: ageGroups.map(group => group.length ? group.reduce((a, b) => a + b, 0) / group.length : 0),
            backgroundColor: ["#F4CFDF", "#9AC8EB", "#5784BA"]
          }]
        },
        options: {
          plugins: { title: { display: true, text: "R√©partition des √Çges par R√©sultat" } },
          scales: { y: { beginAtZero: true } }
        }
      });

      // Radar Chart - Comparaison √¢ge, FCVC, probabilit√©
      new Chart(document.getElementById("chartRadar"), {
        type: "radar",
        data: {
          labels: data.map((p, i) => `Patient ${i + 1}`),
          datasets: [
            {
              label: "√Çge",
              data: data.map(p => {
                const payload = JSON.parse(p.payload || '{}');
                return payload.age || 0;
              }),
              borderColor: "#FF6384",
              fill: false
            },
            {
              label: "FCVC",
              data: data.map(p => {
                const payload = JSON.parse(p.payload || '{}');
                return payload.fcvc || 0;
              }),
              borderColor: "#36A2EB",
              fill: false
            },
            {
              label: "Probabilit√© (%)",
              data: data.map(p => (p.probability * 100).toFixed(1)),
              borderColor: "#FFCE56",
              fill: false
            }
          ]
        },
        options: {
          plugins: { title: { display: true, text: "Comparaison √Çge, FCVC, Probabilit√©" } },
          scales: { r: { beginAtZero: true } }
        }
      });
    }

    // S√©lecteur p√©riode
    const periodSelect = document.getElementById("period-select");
    periodSelect.addEventListener("change", () => {
      const filteredData = filterByPeriod(periodSelect.value);
      renderCharts(filteredData);
    });

    // Initial render sera fait par loadPredictions()

    // ------------------ BOUTON STATISTIQUES ------------------
    const btnShowStats = document.getElementById("btnShowStats");
    const chartsSection = document.getElementById("charts");
    const tableSection = document.getElementById("tableSection");
    const chartFilters = document.getElementById("chart-filters");

    btnShowStats.addEventListener("click", () => {
      const isChartsHidden = chartsSection.style.display === "none" || chartsSection.style.display === "";
      chartsSection.style.display = isChartsHidden ? "block" : "none";
      tableSection.style.display = isChartsHidden ? "none" : "block";
      chartFilters.style.display = isChartsHidden ? "block" : "none";
      btnShowStats.textContent = isChartsHidden ? "‚¨Ö Retour au tableau" : "üìä Statistiques";
      const targetSection = isChartsHidden ? chartsSection : tableSection;
      targetSection.scrollIntoView({ behavior: "smooth" });
    });

    // ------------------ MODE SOMBRE ------------------
    const toggleBtn = document.getElementById("darkModeToggle");
    toggleBtn.addEventListener("click", () => {
      document.body.classList.toggle("dark");
      toggleBtn.textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è Mode clair" : "üåô Mode sombre";
    });
  </script>
  <script>
    // Modifier profil utilisateur
    function editProfile() {
      const name = prompt("Modifier le nom :", "Salim Majide");
      const role = prompt("Modifier le r√¥le :", "Utilisateur");

      if (name) document.querySelector("#user-profile strong").textContent = name;
      if (role) document.querySelector("#user-profile div:nth-child(2)").textContent = `R√¥le : ${role}`;
    }
    function checkPredictionsNotifications() {
      const notificationsDiv = document.getElementById("notifications");
      notificationsDiv.innerHTML = ""; // Reset notifications

      predictions.forEach(pred => {
        let notif = document.createElement("div");
        notif.style.padding = "10px 15px";
        notif.style.borderRadius = "5px";
        notif.style.marginTop = "5px";
        notif.style.boxShadow = "0 2px 5px rgba(0,0,0,0.3)";
        notif.style.color = "#fff";

        if (pred.result === "Ob√®se" && pred.probability > 0.9) {
          notif.style.background = "#5784BA"; // rouge
          notif.textContent = `‚ö†Ô∏è Alerte : pr√©diction Ob√®se √† ${(pred.probability * 100).toFixed(1)}% le ${pred.date}`;
          notificationsDiv.appendChild(notif);
        }
        else if (pred.result === "Sain" && pred.probability > 0.8) {
          notif.style.background = "#F4CFDF"; // vert
          notif.textContent = `‚úÖ Bonne nouvelle : pr√©diction Sain √† ${(pred.probability * 100).toFixed(1)}% le ${pred.date}`;
          notificationsDiv.appendChild(notif);
        }
      });
    }

    // Appeler au chargement
    checkPredictionsNotifications();

  </script>
  <script>
    let currentPage = 1;
    let rowsPerPage = 5;

    function renderHistoryWithPagination(data = predictions) {
      const tableBody = document.querySelector("#history-table tbody");
      tableBody.innerHTML = "";

      rowsPerPage = parseInt(document.getElementById("rowsPerPage").value);

      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pageData = data.slice(start, end);

      pageData.forEach(pred => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
      <td>${pred.date}</td>
      <td>${pred.age}</td>
      <td>${pred.fcvc}</td>
      <td class="${pred.result === 'Ob√®se' ? 'result-1' : 'result-0'}">${pred.result}</td>
      <td>${(pred.probability * 100).toFixed(1)}%</td>
    `;
        tableBody.appendChild(tr);
      });
    }

    function nextPage() {
      const totalPages = Math.ceil(predictions.length / rowsPerPage);
      if (currentPage < totalPages) currentPage++;
      renderHistoryWithPagination();
    }

    function prevPage() {
      if (currentPage > 1) currentPage--;
      renderHistoryWithPagination();
    }

    // Initialiser
    renderHistoryWithPagination();
  </script>
</body>

</html>