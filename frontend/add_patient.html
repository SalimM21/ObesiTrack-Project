<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nouvelle Pr√©diction - D√©tection Diab√®te</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fafafa;
      color: #333;
      padding: 10px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #2196F3;
      color: white;
      padding: 10px;
      border-radius: 5px;
    }

    header nav a {
      color: white;
      margin-left: 15px;
      text-decoration: none;
      font-weight: bold;
    }

    form {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      max-width: 400px;
      gap: 10px;
    }

    label {
      font-weight: bold;
    }

    input {
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    button {
      padding: 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      background: #007bff;
      color: white;
      transition: 0.3s;
    }

    button:hover {
      opacity: 0.85;
    }

    #prediction-result {
      margin-top: 20px;
      font-weight: bold;
      padding: 10px;
      border-radius: 5px;
    }

    .result-sain {
      background: #d4edda;
      color: #155724;
    }

    .result-surpoids {
      background: #fff3cd;
      color: #856404;
    }

    .result-obese {
      background: #f8d7da;
      color: #721c24;
    }

    #chartContainer {
      margin-top: 20px;
      max-width: 400px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }

    th {
      background-color: #f0f0f0;
      cursor: pointer;
    }

    #filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
      align-items: center;
    }

    @media (max-width: 500px) {

      form,
      #chartContainer,
      table {
        width: 100%;
      }
    }

    .spinner {
      border: 4px solid #f3f3f3;
      /* gris clair */
      border-top: 4px solid #4CAF50;
      /* vert pour coh√©rence */
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    #prediction-form label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }

    #prediction-form input {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
  </style>
</head>

<body>


  <header
    style="display:flex; justify-content:space-between; align-items:center; padding:15px; background:#2196F3; color:white; flex-wrap:wrap;">

    <h1 style="margin:0;">Nouvelle Pr√©diction </h1>

    <div style="display:flex; align-items:center; gap:15px; flex-wrap:wrap;">
      <!-- Boutons -->
      <button onclick="location.href='dashboard.html'" class="btn btn-secondary"
        style="background:white; color:#2196F3; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">
        üìä Tableau de bord
      </button>

      <button onclick="location.href='index.html'" class="btn btn-danger"
        style="background:#f44336; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">
        üö™ D√©connexion
      </button>

      <!-- Profil utilisateur -->
      <div id="user-profile"
        style="display:flex; align-items:center; gap:10px; background:rgba(255,255,255,0.1); padding:5px 10px; border-radius:8px;">
        <img src="images/avatar.png" alt="Profil" style="width:40px; height:40px; border-radius:50%;">
        <div style="line-height:1.2;">
          <div><strong>Utilisateur</strong></div>
          <div style="font-size:0.85em;">R√¥le : M√©decin</div>
        </div>
        <button class="btn btn-primary" onclick="editProfile()"
          style="background:#2196F3; color:white; border:none; padding:5px 10px; border-radius:6px; cursor:pointer; font-size:0.85em;">
          ‚úèÔ∏è Modifier
        </button>
      </div>
    </div>
  </header>


  <!-- Formulaire pr√©diction -->
  <main style="display:flex; gap:30px; align-items:flex-start; flex-wrap:wrap;">

    <!-- Formulaire -->
    <form id="prediction-form" style="flex:1; min-width:300px;">
      <label for="age">√Çge</label>
      <input type="number" id="age" name="age" min="5" max="100" placeholder="Entrez votre √¢ge" required>

      <label for="gender">Genre</label>
      <select id="gender" name="gender" required>
        <option value="">S√©lectionnez</option>
        <option value="Male">Homme</option>
        <option value="Female">Femme</option>
      </select>

      <label for="height">Taille (m)</label>
      <input type="number" id="height" name="height" step="0.01" min="0.5" max="2.5" placeholder="Ex. 1.70" required>

      <label for="weight">Poids (kg)</label>
      <input type="number" id="weight" name="weight" step="0.1" min="20" max="300" placeholder="Ex. 70" required>

      <label for="family_history_with_overweight">Ant√©c√©dents familiaux de surpoids</label>
      <select id="family_history_with_overweight" name="family_history_with_overweight" required>
        <option value="">S√©lectionnez</option>
        <option value="yes">Oui</option>
        <option value="no">Non</option>
      </select>

      <label for="favc">Consommation fr√©quente d'aliments caloriques</label>
      <select id="favc" name="favc" required>
        <option value="">S√©lectionnez</option>
        <option value="yes">Oui</option>
        <option value="no">Non</option>
      </select>

      <label for="fcvc">Fr√©quence de consommation de l√©gumes (1-3)</label>
      <input type="number" id="fcvc" name="fcvc" step="0.1" min="1" max="3" placeholder="Ex. 2.5" required>

      <label for="ncp">Nombre de repas principaux (1-8)</label>
      <input type="number" id="ncp" name="ncp" min="1" max="8" placeholder="Ex. 3" required>

      <label for="caec">Consommation d'aliments entre les repas</label>
      <select id="caec" name="caec" required>
        <option value="">S√©lectionnez</option>
        <option value="no">Jamais</option>
        <option value="sometimes">Parfois</option>
        <option value="frequently">Souvent</option>
        <option value="always">Toujours</option>
      </select>

      <label for="smoke">Fumez-vous ?</label>
      <select id="smoke" name="smoke" required>
        <option value="">S√©lectionnez</option>
        <option value="yes">Oui</option>
        <option value="no">Non</option>
      </select>

      <label for="ch2o">Consommation d'eau quotidienne (0-10)</label>
      <input type="number" id="ch2o" name="ch2o" step="0.1" min="0" max="10" placeholder="Ex. 2.5" required>

      <label for="scc">Surveillance des calories</label>
      <select id="scc" name="scc" required>
        <option value="">S√©lectionnez</option>
        <option value="yes">Oui</option>
        <option value="no">Non</option>
      </select>

      <label for="faf">Fr√©quence d'activit√© physique (0-7)</label>
      <input type="number" id="faf" name="faf" step="0.1" min="0" max="7" placeholder="Ex. 1.5" required>

      <label for="tue">Temps d'utilisation d'appareils technologiques (0-24)</label>
      <input type="number" id="tue" name="tue" step="0.1" min="0" max="24" placeholder="Ex. 2.5" required>

      <label for="cal">Consommation d'alcool (0-3)</label>
      <input type="number" id="cal" name="cal" min="0" max="3" placeholder="Ex. 0" required>

      <label for="mtrans">Moyen de transport</label>
      <select id="mtrans" name="mtrans" required>
        <option value="">S√©lectionnez</option>
        <option value="Public_Transportation">Transport public</option>
        <option value="Automobile">Voiture</option>
        <option value="Walking">Marche</option>
        <option value="Bike">V√©lo</option>
        <option value="Motorbike">Moto</option>
      </select>

      <!-- Boutons -->
      <div style="margin-top:15px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <button type="submit" id="submit-btn"
          style="background:#1976D2; color:white; padding:10px 15px; border:none; border-radius:6px; cursor:pointer;">
          üîÆ Obtenir une pr√©diction
        </button>

        <button type="button" id="reset-btn"
          style="background:#6c757d; color:white; padding:10px 15px; border:none; border-radius:6px; cursor:pointer;">
          ‚ôªÔ∏è R√©initialiser
        </button>

        <!-- Spinner -->
        <div id="loading-spinner" style="display:none; margin-left:15px; vertical-align:middle;">
          <div class="spinner"></div>
          <span style="margin-left:8px;">Chargement‚Ä¶</span>
        </div>
      </div>

      <!-- R√©sultat -->
      <div id="prediction-result" style="margin-top:15px;"></div>
    </form>

    <!-- Graphique -->
    <div id="chartContainer" style="flex:1; min-width:300px;">
      <canvas id="probChart" style="width:100%; height:300px;"></canvas>
    </div>



    <!-- Filtrage historique -->
    <div id="filters">
      <input type="text" id="search-input" placeholder="üîç Rechercher (r√©sultat, √¢ge...)">
      <label for="date-min">Du :</label>
      <input type="date" id="date-min">
      <label for="date-max">Au :</label>
      <input type="date" id="date-max">
      <button onclick="applyFilters()">Filtrer</button>
      <button onclick="resetFilters()">R√©initialiser</button>
      <button onclick="exportCSV()">üì• Exporter CSV</button>
    </div>

    <!-- Historique des pr√©dictions -->
    <table id="history-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>√Çge</th>
          <th>FCVC</th>
          <th>Poids</th>
          <th>Taille</th>
          <th>R√©sultat</th>
          <th>Probabilit√©</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rempli dynamiquement -->
      </tbody>
    </table>
  </main>

  <script>
    const form = document.getElementById('prediction-form');
    const resultDiv = document.getElementById('prediction-result');
    const resetBtn = document.getElementById('reset-btn');
    const tableBody = document.querySelector("#history-table tbody");
    const searchInput = document.getElementById("search-input");
    const dateMin = document.getElementById("date-min");
    const dateMax = document.getElementById("date-max");
    let chart;
    let history = [];

    // Charger l'historique depuis l'API
    async function loadHistory() {
      try {
        history = await getHistory();
        renderHistory();
      } catch (err) {
        console.error('Erreur lors du chargement de l\'historique:', err);
      }
    }

    function showResult(predictionResult) {
      const result = predictionResult.result;
      const probabilities = predictionResult.probability;
      
      // Trouver la probabilit√© la plus √©lev√©e
      const maxProb = Math.max(...Object.values(probabilities));
      const maxProbKey = Object.keys(probabilities).find(key => probabilities[key] === maxProb);
      
      let className = result.includes("Obese") ? "result-obese" :
        result.includes("Overweight") ? "result-surpoids" : "result-sain";
      
      resultDiv.className = className;
      resultDiv.innerHTML = `
        <h3>R√©sultat de la pr√©diction</h3>
        <p><strong>Classification :</strong> ${result}</p>
        <p><strong>Probabilit√© la plus √©lev√©e :</strong> ${(maxProb * 100).toFixed(1)}% (${maxProbKey})</p>
        <div style="margin-top: 10px;">
          <h4>D√©tail des probabilit√©s :</h4>
          ${Object.entries(probabilities).map(([key, value]) => 
            `<p>${key}: ${(value * 100).toFixed(1)}%</p>`
          ).join('')}
        </div>
      `;

      if (result.includes("Obese") && maxProb > 0.9) {
        alert("‚ö†Ô∏è Attention : probabilit√© √©lev√©e d'ob√©sit√© !");
      }

      // Mettre √† jour le graphique
      const ctx = document.getElementById('probChart').getContext('2d');
      if (chart) chart.destroy();
      
      const labels = Object.keys(probabilities);
      const data = Object.values(probabilities).map(v => v * 100);
      
      chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: ['#F44336', '#FF9800', '#4CAF50', '#2196F3', '#9C27B0', '#FF5722', '#607D8B']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            title: { display: true, text: 'Probabilit√©s de classification (%)' }
          }
        }
      });
    }

    function renderHistory(data = history) {
      tableBody.innerHTML = "";
      if (!data || data.length === 0) {
        tableBody.innerHTML = "<tr><td colspan='7'>Aucune pr√©diction trouv√©e</td></tr>";
        return;
      }
      
      data.forEach(pred => {
        const tr = document.createElement("tr");
        const payload = JSON.parse(pred.payload || '{}');
        const date = new Date(pred.created_at).toLocaleDateString();
        
        tr.innerHTML = `
        <td>${date}</td>
        <td>${payload.age || '-'}</td>
        <td>${payload.fcvc || '-'}</td>
        <td>${payload.weight || '-'}</td>
        <td>${payload.height || '-'}</td>
        <td class="${pred.result.includes('Obese') ? 'result-obese' : pred.result.includes('Overweight') ? 'result-surpoids' : 'result-sain'}">${pred.result}</td>
        <td>${(pred.probability * 100).toFixed(1)}%</td>
      `;
        tableBody.appendChild(tr);
      });
    }

    function applyFilters() {
      const searchTerm = searchInput.value.toLowerCase();
      const minDate = dateMin.value ? new Date(dateMin.value) : null;
      const maxDate = dateMax.value ? new Date(dateMax.value) : null;
      const filtered = history.filter(p => {
        const payload = JSON.parse(p.payload || '{}');
        const matchesSearch = p.result.toLowerCase().includes(searchTerm) || 
                             String(payload.age || '').includes(searchTerm);
        const dateObj = new Date(p.created_at);
        const matchesDate = (!minDate || dateObj >= minDate) && (!maxDate || dateObj <= maxDate);
        return matchesSearch && matchesDate;
      });
      renderHistory(filtered);
    }

    function resetFilters() {
      searchInput.value = "";
      dateMin.value = "";
      dateMax.value = "";
      renderHistory();
    }

    function exportCSV() {
      let csv = "Date,√Çge,FCVC,Poids,Taille,R√©sultat,Probabilit√©\n";
      history.forEach(p => {
        const payload = JSON.parse(p.payload || '{}');
        const date = new Date(p.created_at).toLocaleDateString();
        csv += `${date},${payload.age || '-'},${payload.fcvc || '-'},${payload.weight || '-'},${payload.height || '-'},${p.result},${(p.probability * 100).toFixed(1)}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'historique_predictions.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // V√©rifier si l'utilisateur est connect√©
      const token = getToken();
      if (!token) {
        alert('‚ùå Vous devez √™tre connect√© pour faire une pr√©diction. Redirection vers la page de connexion...');
        window.location.href = 'index.html';
        return;
      }
      
      // Afficher le spinner de chargement
      const submitBtn = document.getElementById('submit-btn');
      const spinner = document.getElementById('loading-spinner');
      submitBtn.disabled = true;
      spinner.style.display = 'inline-flex';
      
      const formData = new FormData(form);
      const predictionData = {
        age: parseInt(formData.get('age')),
        gender: formData.get('gender'),
        height: parseFloat(formData.get('height')),
        weight: parseFloat(formData.get('weight')),
        family_history_with_overweight: formData.get('family_history_with_overweight'),
        favc: formData.get('favc'),
        fcvc: parseFloat(formData.get('fcvc')),
        ncp: parseInt(formData.get('ncp')),
        caec: formData.get('caec'),
        smoke: formData.get('smoke'),
        ch2o: parseFloat(formData.get('ch2o')),
        scc: formData.get('scc'),
        faf: parseFloat(formData.get('faf')),
        tue: parseFloat(formData.get('tue')),
        cal: parseInt(formData.get('cal')),
        mtrans: formData.get('mtrans')
      };

      try {
        console.log('Envoi des donn√©es de pr√©diction:', predictionData);
        const result = await sendPrediction(predictionData);
        console.log('R√©sultat re√ßu:', result);
        showResult(result);
        await loadHistory(); // Recharger l'historique
      } catch (err) {
        console.error('Erreur lors de la pr√©diction:', err);
        alert('‚ùå Erreur lors de la pr√©diction: ' + err.message);
      } finally {
        // Masquer le spinner et r√©activer le bouton
        submitBtn.disabled = false;
        spinner.style.display = 'none';
      }
    });

    resetBtn.addEventListener('click', () => {
      form.reset();
      resultDiv.textContent = '';
      if (chart) chart.destroy();
    });

    // V√©rifier l'authentification et charger l'historique au chargement de la page
    window.addEventListener('load', () => {
      const token = getToken();
      if (!token) {
        alert('‚ùå Vous devez √™tre connect√© pour acc√©der √† cette page. Redirection...');
        window.location.href = 'index.html';
        return;
      }
      loadHistory();
    });
  </script>
</body>

</html>